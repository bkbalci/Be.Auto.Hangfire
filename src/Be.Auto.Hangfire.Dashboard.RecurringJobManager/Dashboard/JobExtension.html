<link rel="stylesheet" type="text/css" href="recurring-job-manager/css/jobExtension" />
<link rel="stylesheet" type="text/css" href="recurring-job-manager/css/cron-expression-input" />
<link rel="stylesheet" type="text/css" href="recurring-job-manager/css/fontawesome" />


<script src="recurring-job-manager/js/vue"></script>
<script src="recurring-job-manager/js/axio"></script>
<script src="recurring-job-manager/js/sweetalert"></script>
<script defer src="recurring-job-manager/js/page"></script>
<script src="recurring-job-manager/js/daysjs"></script>
<script src="recurring-job-manager/js/relativeTime"></script>
<script>dayjs.extend(dayjs_plugin_relativeTime);</script>
<script src="recurring-job-manager/js/cron-expression-input"></script>
<script src="recurring-job-manager/js/jsoneditor"></script>

<script type="text/x-template" id="modal-template">
    <transition name="modal">
        <div class="modal-mask">
            <div class="modal-wrapper">
                <div class="modal-container">

                    <div class="modal-header">
                        <slot name="header">
                            default header
                        </slot>
                    </div>


                    <div class="modal-scroll">

                        <div class="modal-body">
                            <slot name="body">
                                default body
                            </slot>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button class="modal-default-button btn btn-danger pull-left" @click="closeModal">
                            Close
                        </button>
                        <slot name="footer">
                            <button class="modal-default-button btn btn-success" @click="closeModal">
                                Save
                            </button>
                        </slot>
                    </div>
                </div>
            </div>
        </div>
    </transition>
</script>

<div id="app">

    <modal v-if="showModal" @close="closeModal">
        <template v-slot:header>
            <h3>{{ title }}</h3>
        </template>
        <template v-slot:body>
            <form id="formJob">
                <input type="hidden" name="JobIdBefore" id="JobIdBefore" />
                <div class="form-group">
                    <label for="JobType">Job Type</label>
                    <select id="JobType" name="JobType" class="form-control" v-model="job.JobType" @change="onJobTypeChange">
                        <option value="">Please select</option>
                        <option v-for="(item, index) in jobTypes" :key="index" :value="item.Value">{{ item.Text }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="MisfireHandlingMode">Misfire Handling Mode</label>
                    <select id="MisfireHandlingMode" name="MisfireHandlingMode" class="form-control" v-model="job.MisfireHandlingMode">
                        <option value="">Please select</option>
                        <option v-for="(item, index) in misfireHandlingModes" :key="index" :value="item.Value">{{ item.Text }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="Id">Job Id</label>
                    <input type="text" class="form-control" v-model="job.Id" id="Id" name="Id" placeholder="Enter Job Id">
                </div>
                <div class="form-group">
                    <label for="TimeZoneId">Time Zone</label>
                    <select id="TimeZoneId" name="TimeZoneId" class="form-control" v-model="job.TimeZoneId">
                        <option value="">Please select</option>
                        <option v-for="(item, index) in timeZones" :key="index" :value="item.Item1">{{ item.Item2 }}</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="Cron">Cron</label>
                    <input type="hidden" id="Cron" name="Cron" v-model="job.Cron" />
                    <cron-expression-input :value="job.Cron" v-on:input="onCronChange" color="d58512" />
                </div>

                <div class="form-group" v-if="job.JobType === 'MethodCall'">
                    <label for="Class">Class</label>
                    <select id="Class" name="Class" class="form-control" v-model="job.Class" @change="onClassChange">
                        <option value="">Please select</option>
                        <option v-for="(item, index) in assemblyTypes" :key="index" :value="item">{{ item }}</option>

                    </select>
                </div>
                <div class="form-group" v-if="job.JobType === 'MethodCall' &&  job.Class!=''">
                    <label for="Method">Method</label>
                    <select id="Method" name="Method" class="form-control" v-model="job.Method" @change="getAssemblyTypeMethodJsonSchema">
                        <option value="">Please select</option>
                        <option v-for="(item, index) in assemblyTypeMethods" :key="index" :value="item">{{ item }}</option>
                    </select>
                </div>
                <div class="form-group" v-if="job.JobType === 'MethodCall' && job.Method!=''">
                    <label for="methodParametersJsonEditor">Method Parameters</label>
                    <input type="hidden" id="MethodParameters" name="MethodParameters" v-model="job.MethodParameters">
                    <div id="methodParametersJsonEditor"></div>
                </div>
                <div class="form-group" v-if="job.JobType === 'WebRequest'">
                    <label for="HostName">HostName</label>
                    <input type="text" class="form-control" v-model="job.HostName" id="HostName" name="HostName" placeholder="Example: http://HostName.com">
                </div>
                <div class="form-group" v-if="job.JobType === 'WebRequest'">
                    <label for="UrlPath">Path</label>
                    <input type="text" class="form-control" v-model="job.UrlPath" id="UrlPath" name="UrlPath" placeholder="Example: /api/get-products">
                </div>
                <div class="form-group" v-if="job.JobType === 'WebRequest'">
                    <label for="HttpMethod">Http Method</label>
                    <select id="HttpMethod" name="HttpMethod" class="form-control" v-model="job.HttpMethod" @change="getBodyParameterTypes">
                        <option value="">Please select</option>
                        <option v-for="(item, index) in httpMethods" :key="index" :value="item">{{ item }}</option>
                    </select>
                </div>
                <div class="form-group table-group" v-if="job.JobType === 'WebRequest'">

                    <input type="hidden" id="HeaderParameters" name="HeaderParameters" v-model="job.HeaderParameters">
                    <div id="headerParametersJsonEditor"></div>
                </div>
                <div class="form-group" v-if="job.JobType === 'WebRequest' && job.HttpMethod!=''">
                    <label for="BodyParameterType">Body Parameters Type</label>
                    <select id="BodyParameterType" name="BodyParameterType" @change="onBodyParameterTypeChange" class="form-control" v-model="job.BodyParameterType">
                        <option value="">Please select</option>
                        <option :disabled="job.HttpMethodGet && item.Value === 'Json'" v-for="(item, index) in bodyParameterTypes" :key="index" :value="item.Value">{{ item.Text }}</option>
                    </select>
                </div>

                <div class="form-group table-group" v-if="job.JobType === 'WebRequest' && (job.BodyParameterType ==='Json' || job.BodyParameterType ==='FormUrlEncoded'  || job.BodyParameterType ==='FormData')">
                    <input type="hidden" id="BodyParameters" name="BodyParameters" v-model="job.BodyParameters">
                    <div id="bodyParametersJsonEditor"></div>
                </div>


                <div class="form-group table-group" v-if="job.JobType === 'WebRequest' && (job.BodyParameterType ==='Xml' || job.BodyParameterType ==='PlainText' )">
                    <label for="bodyParameterXmlOrText">Body Parameters</label>
                    <textarea @change="bodyParameterXmlOrTextOnChange" class="form-control" rows="10" type="hidden" id="bodyParameterXmlOrText" name="bodyParameterXmlOrText" v-model="bodyParameterXmlOrText"></textarea>
                </div>

                <div class="form-group" v-if="errors.length > 0">
                    <b style="color:red">Please correct the following error(s):</b>
                    <ul>
                        <li v-for="error in errors" :key="error" style="color:red">{{ error }}</li>
                    </ul>
                </div>
            </form>
        </template>
        <template v-slot:footer>
            <button class="btn btn-success" @click="addJob">Save</button>
        </template>
    </modal>


    <div class="row">
        <div class="col-md-12" style="margin:0px;padding:0px;">
            <h1 class="page-header">Recurring Jobs <span class="badge badge-warning">{{getItems.length}}</span></h1>
            <button type="button" class="btn btn-primary" @click="OpenModal">Add new Job</button>

            <div class="table-responsive">
                <table id="joblist" class="table">

                    <thead>
                        <tr>
                            <th>Actions</th>
                            <th>Id</th>
                            <th>Cron</th>
                            <th>Misfire Handling Mode</th>
                            <th>State</th>
                            <th>JobType</th>
                            <th>Class / HostName</th>
                            <th>Method / Path</th>
                            <th>TimeZone</th>
                            <th>Last Execution</th>
                            <th>Next Execution</th>

                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="job in getItems" :key="job.Id">
                            <td>
                                <table>
                                    <tr>
                                        <td>
                                            <button type="button" class="btn btn-warning" style="padding-top: 10px; margin-right: 5px;">
                                                <svg width="18px" height="18px" viewBox="0 0 16 16" class="bi bi-pencil-square" fill="currentColor" @click="GetJob(job.Id)">
                                                    <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456l-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z" />
                                                    <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z" />
                                                </svg>
                                            </button>
                                        </td>
                                        <td>
                                            <button v-if="job.JobState == 'Stopped'" type="button" class="btn btn-success" style="padding: 4px 10px;" @click="StartJob(job.Id)">
                                                <svg width="24px" height="25px" viewBox="-1 -1.5 16 16" class="bi bi-play" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10.804 8L5 4.633v6.734L10.804 8zm.792-.696a.802.802 0 0 1 0 1.392l-6.363 3.692C4.713 12.69 4 12.345 4 11.692V4.308c0-.653.713-.998 1.233-.696l6.363 3.692z" />
                                                </svg>
                                            </button>
                                            <button v-if="job.JobState == 'Running'" type="button" class="btn btn-danger" style="padding: 4px 10px;" @click="StopJob(job.Id)">
                                                <svg width="24px" height="25px" viewBox="-0.5 -1.5 16 16" class="bi bi-stop" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M3.5 5A1.5 1.5 0 0 1 5 3.5h6A1.5 1.5 0 0 1 12.5 5v6a1.5 1.5 0 0 1-1.5 1.5H5A1.5 1.5 0 0 1 3.5 11V5zM5 4.5a.5.5 0 0 0-.5.5v6a.5.5 0 0 0 .5.5h6a.5.5 0 0 0 .5-.5V5a.5.5 0 0 0-.5-.5H5z" />
                                                </svg>
                                            </button>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                            <td>{{ job.Id }}</td>
                            <td>{{ job.Cron }}</td>
                            <td>{{ job.MisfireHandlingMode }}</td>
                            <td>
                                <span :class="{'label label-success': job.JobState == 'Running', 'label label-danger': job.JobState == 'Stopped'}">
                                    {{ job.JobState }}
                                </span>
                            </td>
                            <td>{{ job.JobType }}</td>
                            <td>{{ job.JobType === 'WebRequest' ? job.HostName : job.Class }}</td>
                            <td>{{ job.JobType === 'WebRequest' ? job.UrlPath : job.Method  }}</td>
                            <td>{{ job.TimeZoneId }}</td>
                            <td>
                                <button type="button" class="btn btn-primary">
                                    {{ getTimeFromNow(job.LastExecution) }}&nbsp;&nbsp;
                                    <span class="badge" style="width: 124px;">
                                        {{ capitalizeString(getTimeFromNow(job.LastExecution)) }}
                                    </span>
                                </button>
                            </td>
                            <td>
                                <button type="button" class="btn btn-primary">
                                    {{ getTimeFromNow(job.NextExecution) }}&nbsp;&nbsp;
                                    <span class="badge" style="width: 124px;">
                                        {{ capitalizeString(getTimeFromNow(job.NextExecution)) }}
                                    </span>
                                </button>
                            </td>
                        </tr>

                    </tbody>
                </table>


            </div>


            <div style="float: right;">
                <paginate :page-count="getPageCount"
                          :page-range="3"
                          :margin-pages="2"
                          :click-handler="clickCallbackPagination"
                          :prev-text="'＜'"
                          :next-text="'＞'"
                          :container-class="'pagination'"
                          :page-class="'page-item'">
                </paginate>
            </div>
        </div>
    </div>

</div>

<script>



    const { ref, computed, createApp, nextTick } = Vue;

    const ModalComponent = {
        template: '#modal-template',
        methods: {
            closeModal() {
                this.$emit('close');
            }
        }
    };

    const app = createApp({
        components: {
            'modal': ModalComponent,
        },
        setup() {
            const title = ref('Add New Job');
            const jobs = ref(null);
            const bodyParameterXmlOrText = ref('');
            const showModal = ref(false);
            const errors = ref([]);
            const timeZones = ref([]);
            const jobTypes = ref([]);
            const bodyParameterTypes = ref([]);
            const assemblyTypes = ref([]);
            const assemblyTypeMethods = ref([]);
            const httpMethods = ref([]);
            const misfireHandlingModes = ref([]);
            const methodParametersJsonEditor = ref(null);
            const headerParametersJsonEditor = ref(null);
            const bodyParametersJsonEditor = ref(null);
            const job = ref({
                Id: '',
                Cron: '',
                JobType: '',
                Class: '',
                Method: '',
                HttpMethod: '',
                BodyParameterType: '',
                MisfireHandlingMode: '',
                BodyParameters: '',
                HeaderParameters: '',
                HostName: '',
                UrlPath: '',
                JobState: '',
                NextExecution: '',
                LastJobId: '',
                LastJobState: '',
                LastExecution: '',
                CreatedAt: '',
                Removed: false,
                TimeZoneId: '',
                Error: '',
                MethodParameters: ''
            });
            const pagination = ref({
                parPage: 10,
                currentPage: 1
            });
            const selectedJobType = ref('');
            const headerCount = ref(0);

            const initBodyParametersJsonEditor = () => {
                Vue.nextTick(() => {
                    const element = document.getElementById('bodyParametersJsonEditor');

                    if (bodyParametersJsonEditor.value)
                        bodyParametersJsonEditor.value.destroy();




                    switch (job.value.BodyParameterType) {

                        case "Json":

                            bodyParametersJsonEditor.value = new JSONEditor(element, {
                                schema: {
                                    "type": "object",
                                    "title": "Body Parameters"

                                },
                                iconlib: 'fontawesome5',
                                object_layout: 'grid',
                                show_errors: 'interaction',
                                theme: 'bootstrap5',
                                remove_button_labels: true,
                                no_additional_properties: false,
                                enable_array_copy: false,
                                disable_properties: false,
                                array_controls_top: true,
                                disable_array_reorder: true,
                                disable_collapse: true,
                                disable_edit_json: false
                            });


                            break;
                        case "FormUrlEncoded":

                            bodyParametersJsonEditor.value = new JSONEditor(element, {
                                schema: {
                                    "type": "array",
                                    "title": "Query Parameters",
                                    "items": {
                                        "type": "object",
                                        "title": "Parameter",
                                        "properties": {
                                            "Name": {
                                                "title": "Key",
                                                "type": "string",
                                            },
                                            "Value": {
                                                "title": "value",
                                                "type": "string"
                                            }
                                        },
                                        "required": ["Name", "Value"]
                                    }
                                },
                                iconlib: 'fontawesome5',
                                object_layout: 'grid',
                                show_errors: 'interaction',
                                theme: 'bootstrap5',
                                remove_button_labels: true,
                                no_additional_properties: false,
                                enable_array_copy: false,
                                disable_properties: false,
                                array_controls_top: true,
                                disable_array_reorder: true,
                                disable_collapse: true,
                                disable_edit_json: false
                            });


                            break;

                        case "FormData":

                            bodyParametersJsonEditor.value = new JSONEditor(element, {
                                schema: {
                                    "type": "array",
                                    "title": "Body Parameters",
                                    "items": {
                                        "type": "object",
                                        "title": "Parameter",
                                        "properties": {
                                            "Name": {
                                                "title": "Key",
                                                "type": "string",
                                            },
                                            "Value": {
                                                "title": "Value",
                                                "type": "string"
                                            },
                                            "ContentType": {
                                                "title": "Content Type",
                                                "type": "string"
                                            }
                                        },
                                        "required": ["Name", "Value", "ContentType"]
                                    }
                                },
                                iconlib: 'fontawesome5',
                                object_layout: 'grid',
                                show_errors: 'interaction',
                                theme: 'bootstrap5',
                                remove_button_labels: true,
                                no_additional_properties: false,
                                enable_array_copy: false,
                                disable_properties: false,
                                array_controls_top: true,
                                disable_array_reorder: true,
                                disable_collapse: true,
                                disable_edit_json: false
                            });


                            break;
                    }

                    bodyParametersJsonEditor.value.on('change', () => {

                        job.value.BodyParameters = JSON.stringify(bodyParametersJsonEditor.value.getValue());
                    });

                    bodyParametersJsonEditor.value.on('ready', () => {

                        if (job.value.BodyParameters == null || job.value.BodyParameters === undefined || job.value.BodyParameters == '') {

                            bodyParametersJsonEditor.value.setValue(JSON.parse(JSON.parse(job.value.BodyParameters)));
                        }

                    });

                });
            };

            const initHeaderParametersJsonEditor = () => {
                Vue.nextTick(() => {
                    const element = document.getElementById('headerParametersJsonEditor');



                    if (headerParametersJsonEditor.value)
                        headerParametersJsonEditor.value.destroy();

                    headerParametersJsonEditor.value = new JSONEditor(element, {
                        schema: {
                            "type": "array",
                            "title": "Header Parameters",
                            "items": {
                                "type": "object",
                                "title": "Parameter",
                                "properties": {
                                    "Name": {
                                        "title": "Key",
                                        "type": "string",
                                    },
                                    "Value": {
                                        "title": "value",
                                        "type": "string"
                                    }
                                },
                                "required": ["Name", "Value"]
                            }
                        },
                        iconlib: 'fontawesome5',
                        object_layout: 'grid',
                        show_errors: 'interaction',
                        theme: 'bootstrap5',
                        remove_button_labels: true,
                        no_additional_properties: true,
                        enable_array_copy: false,
                        disable_properties: true,
                        array_controls_top: true,
                        disable_array_reorder: true,
                        disable_collapse: true,
                        disable_edit_json: false
                    });

                    headerParametersJsonEditor.value.on('change', () => {

                        job.value.HeaderParameters = JSON.stringify(headerParametersJsonEditor.value.getValue());
                    });

                    headerParametersJsonEditor.value.on('ready', () => {

                        headerParametersJsonEditor.value.setValue(JSON.parse(JSON.parse(job.value.HeaderParameters)));

                    });


                });


            };

            const onJobTypeChange = (e) => {
                job.value.JobType = e.target.value;

                if (job.value.JobType == "WebRequest") {

                    initHeaderParametersJsonEditor();

                }
            };

            const onBodyParameterTypeChange = (e) => {

                job.value.BodyParameterType = e.target.value;

                initBodyParametersJsonEditor();
            };

            const bodyParameterXmlOrTextOnChange = (e) => {


                console.info("bodyParameterXmlOrTextOnChange", e);
            };

            const onClassChange = (e) => {
                job.value.Class = e.target.value;
                assemblyTypeMethods.value = [];
                getAssemblyTypeMethods();
            };

            const addJob = () => {
                UpdateJob(job.value);
            };

            const generateUUID = () => {
                var d = new Date().getTimeFromNow();
                var d2 = ((typeof performance !== 'undefined') && performance.now && (performance.now() * 1000)) || 0;
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    var r = Math.random() * 16;
                    if (d > 0) {
                        r = (d + r) % 16 | 0;
                        d = Math.floor(d / 16);
                    } else {
                        r = (d2 + r) % 16 | 0;
                        d2 = Math.floor(d2 / 16);
                    }
                    return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
                });
            };

            const GetJobs = () => {
                axios.get('recurring-job-manager/get-jobs')
                    .then(res => (jobs.value = res.data))
                    .catch(error => console.error('Error fetching jobs:', error));
            };

            const GetJob = (_Id) => {
                title.value = 'Edit Job';
                axios.get('recurring-job-manager/get-job?Id=' + _Id).then(response => {
                    if (response.data != null) {
                        showModal.value = true;
                        const jobData = response.data.Object;
                        job.value = { ...job.value, ...jobData };


                        Vue.nextTick(() => {

                            document.getElementById("JobIdBefore").value = job.value.Id;

                        });


                        switch (job.value.BodyParameterType) {
                            case "Xml":
                            case "PlainText":
                                bodyParameterXmlOrText.value = job.value.BodyParameters;
                                break;
                        }

                        switch (job.value.JobType) {

                            case "MethodCall":
                                getAssemblyTypeMethods();
                                break;

                            case "WebRequest":

                                initHeaderParametersJsonEditor();
                                initBodyParametersJsonEditor();
                                break;
                        }


                        console.info("JOB", job.value);

                    }
                }).catch(e => {
                    console.log(e);
                });
            };

            const StartJob = (_jobId) => {
                axios.get('recurring-job-manager/job-agent?Id=' + _jobId + "&Action=Start").then(response => {
                    if (!response.data.Status) {
                        showModal.value = false;
                        Swal.fire({
                            title: 'Error!',
                            text: response.data.Message,
                            type: 'error',
                            confirmButtonText: 'Okay'
                        }).then(() => {
                            closeModal();
                        });
                    } else {
                        closeModal();
                        GetJobs();
                    }
                }).catch(e => {
                    console.log(e);
                });
            };

            const StopJob = (_jobId) => {
                axios.get('recurring-job-manager/job-agent?Id=' + _jobId + "&Action=Stop").then(response => {
                    if (!response.data.Status) {
                        showModal.value = false;
                        Swal.fire({
                            title: 'Error!',
                            text: response.data.Message,
                            type: 'error',
                            confirmButtonText: 'Okay'
                        }).then(() => {
                            closeModal();
                        });
                    } else {
                        closeModal();
                        GetJobs();
                    }
                }).catch(e => {
                    console.log(e);
                });
            };

            const UpdateJob = (job) => {
                if (checkForm()) {

                    const formData = new FormData(document.getElementById('formJob'));
                    const params = new URLSearchParams();

                    for (const [key, value] of formData.entries()) {
                        params.append(key, value);
                    }

                    axios.get('recurring-job-manager/update-jobs?' + params.toString()).then(response => {
                        if (!response.data.Status) {
                            showModal.value = false;
                            Swal.fire({
                                title: 'Error!',
                                text: response.data.Message,
                                type: 'error',
                                confirmButtonText: 'Okay'
                            }).then(() => {
                                closeModal();
                            });
                        } else {
                            closeModal();
                            GetJobs();
                        }
                    }).catch(e => {
                        console.log(e);
                    });
                }
            };

            const getTimeZones = () => {
                axios.get('recurring-job-manager/get-time-zones').then(response => {
                    timeZones.value = response.data;
                }).catch(e => {
                    console.log(e);
                });
            };

            const onCronChange = (cronExp) => {

                job.value.Cron = cronExp.detail.value;

            };

            const getAssemblyTypeMethodJsonSchema = () => {

                if (job.value.Class != '' && job.value.Method != '') {

                    axios.get('recurring-job-manager/get-current-assembly-type-method-json-schema?Class=' + job.value.Class + '&Method=' + job.value.Method).then(response => {
                        Vue.nextTick(() => {


                            if (methodParametersJsonEditor.value)
                                methodParametersJsonEditor.value.destroy();

                            methodParametersJsonEditor.value = new JSONEditor(document.getElementById('methodParametersJsonEditor'), {

                                schema: JSON.parse(response.data.Schema),
                                iconlib: 'fontawesome5',
                                object_layout: 'normal',
                                show_errors: 'interaction',
                                theme: 'bootstrap5',
                                remove_button_labels: true,
                                no_additional_properties: true,
                                enable_array_copy: false,
                                disable_properties: false,
                                array_controls_top: true,
                                disable_array_reorder: true,
                                disable_collapse: false,
                                disable_edit_json: false
                            });
                            methodParametersJsonEditor.value.on('change', () => {


                                job.value.MethodParameters = JSON.stringify(methodParametersJsonEditor.value.getValue());
                            });

                            methodParametersJsonEditor.value.on('ready', () => {

                                methodParametersJsonEditor.value.setValue(JSON.parse(JSON.parse(job.value.MethodParameters)));

                            });
                        });


                    }).catch(e => {
                        console.log(e);
                    });
                }

            };

            const getMisfireHandlingModes = () => {
                axios.get('recurring-job-manager/get-misfire-handling-modes').then(response => {
                    misfireHandlingModes.value = response.data;
                }).catch(e => {
                    console.log(e);
                });
            };

            const gethttpMethods = () => {
                axios.get('recurring-job-manager/get-http-methods').then(response => {
                    httpMethods.value = response.data;
                }).catch(e => {
                    console.log(e);
                });
            };

            const getBodyParameterTypes = (e) => {
                axios.get('recurring-job-manager/get-body-parameter-types?HttpMethod=' + e.target.value).then(response => {
                    bodyParameterTypes.value = response.data;
                }).catch(e => {
                    console.log(e);
                });
            };

            const getJobTypes = () => {
                axios.get('recurring-job-manager/get-job-types').then(response => {
                    jobTypes.value = response.data;
                }).catch(e => {
                    console.log(e);
                });
            };

            const getAssemblyTypes = () => {
                axios.get('recurring-job-manager/get-current-assembly-types').then(response => {
                    assemblyTypes.value = response.data;
                }).catch(e => {
                    console.log(e);
                });
            };

            const getAssemblyTypeMethods = () => {
                axios.get('recurring-job-manager/get-current-assembly-type-methods?Class=' + job.value.Class).then(response => {
                    assemblyTypeMethods.value = response.data;


                    getAssemblyTypeMethodJsonSchema();

                }).catch(e => {
                    console.log(e);
                });
            };

            const closeModal = () => {
                job.value = {
                    Id: '',
                    Cron: '',
                    JobType: '',
                    Class: '',
                    Method: '',
                    HttpMethod: '',
                    BodyParameterType: '',
                    MisfireHandlingMode: '',
                    BodyParameters: '',
                    HeaderParameters: '',
                    HostName: '',
                    UrlPath: '',
                    JobState: '',
                    NextExecution: '',
                    LastJobId: '',
                    LastJobState: '',
                    LastExecution: '',
                    CreatedAt: '',
                    Removed: false,
                    TimeZoneId: '',
                    Error: '',
                    MethodParameters: ''
                };
                errors.value = [];
                showModal.value = false;
            };

            const OpenModal = () => {
                title.value = 'Add New Job';
                showModal.value = true;
            };

            const checkForm = () => {
                errors.value = [];

                if (!job.value.JobType) {
                    errors.value.push("Please select a Job Type to proceed.");
                }

                if (!job.value.MisfireHandlingMode) {
                    errors.value.push("Please select a Misfire Handling Mode to proceed.");
                }

                if (!job.value.Id) {
                    errors.value.push("Job ID is missing. Please provide a unique identifier for the job.");
                }

                if (!job.value.Cron) {
                    errors.value.push("Cron expression is missing. Please specify the schedule for the job.");
                }

                switch (job.value.JobType) {
                    case "WebRequest":
                        if (!job.value.HostName) {
                            errors.value.push("HostName URL is required. Please provide the HostName for the web request.");
                        }
                        if (!job.value.UrlPath) {
                            errors.value.push("HostName Path is required. Please specify the path for the web request.");
                        }
                        if (!job.value.HttpMethod) {
                            errors.value.push("HTTP Method is required. Please select the HTTP method (e.g., GET, POST).");
                        }
                        break;

                    case "MethodCall":
                        if (!job.value.Class) {
                            errors.value.push("Class is required for Method Call jobs. Please select a class.");
                        }
                        if (!job.value.Method) {
                            errors.value.push("Method is required for Method Call jobs. Please select a method.");
                        }
                        break;
                }

                return errors.value.length === 0;
            };

            const capitalizeString = (s) => {
                return s.charAt(0).toUpperCase() + s.slice(1);
            };

            const getTimeFromNow = (date) => {
                return dayjs().from(dayjs(date));
            };

            const getItems = computed(() => {
                if (!jobs.value) return [];
                let current = pagination.value.currentPage * pagination.value.parPage;
                let start = current - pagination.value.parPage;
                return jobs.value.slice(start, current);
            });

            const getPageCount = computed(() => {
                if (!jobs.value) return 0;
                return Math.ceil(jobs.value.length / pagination.value.parPage);
            });

            return {
                title,
                jobs,
                showModal,
                errors,
                timeZones,
                jobTypes,
                bodyParameterTypes,
                assemblyTypes,
                assemblyTypeMethods,
                httpMethods,
                misfireHandlingModes,
                methodParametersJsonEditor,
                headerParametersJsonEditor,
                bodyParametersJsonEditor,
                job,
                pagination,
                selectedJobType,
                headerCount,
                initBodyParametersJsonEditor,
                initHeaderParametersJsonEditor,
                onJobTypeChange,
                onBodyParameterTypeChange,
                onCronChange,
                onClassChange,
                addJob,
                generateUUID,
                GetJobs,
                GetJob,
                StartJob,
                StopJob,
                UpdateJob,
                getTimeZones,
                getAssemblyTypeMethodJsonSchema,
                getMisfireHandlingModes,
                gethttpMethods,
                getBodyParameterTypes,
                getJobTypes,
                getAssemblyTypes,
                getAssemblyTypeMethods,
                closeModal,
                OpenModal,
                checkForm,
                capitalizeString,
                getTimeFromNow,
                getItems,
                getPageCount
            };
        },
        mounted() {


            this.getMisfireHandlingModes();
            this.gethttpMethods();
            this.getAssemblyTypes();
            this.getTimeZones();
            this.getJobTypes();
            this.GetJobs();
        }
    });

    app.mount('#app');
</script>